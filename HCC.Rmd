---
title: 'PRA 2: Neteja, validació i anàlisi de les dades'
author: "Álvaro Díaz i David Leiva"
date: "13/12/2020"
output:
  pdf_document:
    toc: yes
    toc_depth: '3'
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 3
header-includes:
- \usepackage{float}
---

```{r setup, include=FALSE,}
knitr::opts_chunk$set(echo = TRUE, fig.width=6, fig.height=4, message= FALSE, warning=FALSE)
library(knitr)
library(tidyverse)
library(kableExtra)
library(VIM)
library(gridExtra)
library(nortest)
```

******
# Detalls de l'activitat
******
## Presentació
En aquesta pràctica s’elabora un cas pràctic orientat a aprendre a identificar les dades rellevants
per un projecte analític i usar les eines d’integració, neteja, validació i anàlisi de les mateixes

## Competències
En aquesta pràctica es desenvolupen les següents competències del Màster de Data Science:

* Capacitat d'analitzar un problema en el nivell d'abstracció adequat a cada situació i aplicar les habilitats i coneixements adquirits per abordar-lo i resoldre'l.
* Capacitat per aplicar les tècniques específiques de tractament de dades (integració,transformació, neteja i validació) per al seu posterior anàlisi.

## Objectius
Els objectius concrets d’aquesta pràctica són:

* Aprendre a aplicar els coneixements adquirits i la seva capacitat de resolució de problemes en entorns nous o poc coneguts dintre de contextos més amplis o multidisciplinaris.
* Saber identificar les dades rellevants i els tractaments necessaris (integració, neteja i validació) per dur a terme un projecte analític.
* Aprendre a analitzar les dades adequadament per abordar la informació continguda en les dades.
* Identificar la millor representació dels resultats per tal d’aportar conclusions sobre el problema plantejat en el procés analític.
* Actuar amb els principis ètics i legals relacionats amb la manipulació de dades en funció de l'àmbit d'aplicació.
* Desenvolupar les habilitats d'aprenentatge que els permetin continuar estudiant d'una manera que haurà de ser en gran manera autodirigida o autònoma.
* Desenvolupar la capacitat de cerca, gestió i ús d'informació i recursos en l'àmbit de la ciència de dades.


******
# Resolució
******
## Descripció del dataset
Es realitzarà l'anàlisi exploratori (EDA) del dataset https://archive.ics.uci.edu/ml/datasets/HCC+Survival on es recopila informació de pacients amb carcinoma hepatocelullar (HCC) i la seva supervivència a l'any. 

L'HCC és el tumor hepàtic més comú en els pacients amb hepatopatia crónica. La supervivència d'aquests pacients no només depen de l'estadi tumoral si no que també depen de l'estat funcional del fetge. 

El conjunt de dades HCC es va obtenir en l´'Hospital Universitari de Coïmbra (Portugal) i contenia diversos factors demogràfics, de risc, de laboratori i de supervivència global de 165 pacients reals diagnosticats de HCC. El conjunt de dades conté 49 funcions seleccionades segons les directrius de pràctica clínica EASL-EORTC (Associació Europea per a l’Estudi del Fetge - Organització Europea per a la Recerca i el Tractament del Càncer), que són els habituals en la gestió de HCC.

Es tracta d’un conjunt de dades heterogeni, amb 23 variables quantitatives i 26 variables qualitatives. La variable objectiu és la supervivència a 1 any i es va codificar com a variable binària: 0 (mor) i 1 (viu).

Les variables del dataset són:

* **Gender (Gen)**: [1=Home;0=Dona] Sexe del pacient

* **Symptoms (Sym)**:[1=Si;0=No] Sintomàtic

* **Alcohol (Alc)**: [1=Si;0=No] Hepatopatia alcohòlica

* **Hepatitis B Surface Antigen (HBS)**: [1=Si;0=No] Antigen de superfície de l'hepatitis B present a la sang

* **Hepatitis B e Antigen (HBe)**:[1=Si;0=No] Antigen e de l'hepatitis B present a la sang

* **Hepatitis B Core Antibody (HBC)**: [1=Si;0=No] Anticòs per l'hepatitis B present a la sang

* **Hepatitis C Virus Antibody (HCV)**: [1=Si;0=No] Anticòs per l'hepatitis C present a la sang

* **Cirrhosis (Cir)**: [1=Si;0=No] Estadio avançat d'hepatopatia crónica

* **Endemic Countries (End)**: [1=Si;0=No] Pacient procedent de països amb alta prevalença d'hepatitis vírica

* **Smoking (Smo)**: [1=Si;0=No] Fumador

* **Diabetes (Dia)**: [1=Si;0=No] Diabètic

* **Obesity (Obe)**: [1=Si;0=No] Obesitat

* **Hemochromatosis (Hem)**:[1=Si;0=No] Hemocromatosi

* **Arterial Hypertension (HyA)**: [1=Si;0=No] Hipertensió arterial

* **Chronic Renal Insufficiency(CRI)**: [1=Si;0=No] Insuficiència renal

* **Human Immunodeficiency Virus (HIV)**: [1=Si;0=No] Infecció per HIV

* **Nonalcoholic Steatohepatitis (Ste)**: [1=Si;0=No] Esteatosis hepàtica de origen no alcohòlic

* **Esophageal Varices (Eso)**: [1=Si;0=No] Presència de varius esofàgiges com indicador d'hipertensió portal

* **Splenomegaly (Spl)**: [1=Si;0=No] Augment del tamany de la melsa com indicador d'hipertensió portal

* **Portal Hypertension (PHT)**: [1=Si;0=No] Pacient amb hipertensió arterial coneguda

* **Portal Vein Thrombosis (PVT)**: [1=Si;0=No] Presència de trombosi venosa portal

* **Liver Metastasis (Met)**: [1=Si;0=No] Metàstasi hepàtica

* **Radiological Hallmark (Rad)**: [1=Si;0=No]Comportament radiològic típic per HCC

* **Age at diagnosis (Age)**: Anys d'edat al moment del diagnóstic de HCC

* **Grams of Alcohol per day (gAl)**: Grams d'alcohol ingerit de mitjana al dia

* **Packs of cigarets per year (PCi)**: Número de paquets de cigarrets consumits per any

* **Performance Status (PSt)**: [0=Activo;1=Restringit;2=Asistencia ocasional;3=Asistencia parcial;4=Asistencia total;5=Mort] Escala de l'estat general del pacient oncològic

* **Encephalopathy degree (Enc)**: [1=Cap;2=Grau I/II; 3=Grau III/IV] Grau d'afectació mental de l'hepatopatia

* **Ascites degree (Asc)**: [1=Cap;2=Lleu;3=Moderada a Severa] Grau d'ascitis com a indicador indirecte d'hipertensió  portal

* **International Normalised Ratio (INR)**: Temps de protrombina

* **Alpha-Fetoprotein (ng/mL) (AFe)**: Nivells del marcador tumoral a la sang

* **Haemoglobin (g/dL) (Hae)**: Nivells de Hemoglobina a la sang

* **Mean Corpuscular Volume (MCV)**: Volum corpuscular mig dels eritrocits

* **Leukocytes(G/L) (Leu)**: Concentració de cél.lules blanques en sang

* **Platelets (Pla)**: Concentració de plaquestes en sang

* **Albumin (mg/dL) (Alb)**: Nivelss d'albumina en sang

* **Total Bilirubin(mg/dL) (BiT)**: Nivells de Bilirrubina Total en sang

* **Alanine transaminase (U/L) (ALT)**: Nivells d'ALT en sang

* **Aspartate transaminase (U/L) (AST)**: Nivells d'ASP en sang

* **Gamma glutamyl transferase (U/L) (GGT)**: Nivells gamma-GT en sang

* **Alkaline phosphatase (U/L) (ALP)**: Nivelss de fosfatasa alcalina en sang

* **Total Proteins (g/dL) (Pro)**: Concentració total de proteïnes en sang

* **Creatinine (mg/dL) (Crea)**: Concentració de creatinina en sang

* **Number of Nodules (Nod)**: Número de nóduls d'HCC visualitzats

* **Major dimension of nodule (cm) (DiN)**: Tamany major dels nóduls d'HCC

* **Direct Bilirubin (mg/dL) (BiD)**: Nivells de Bilirrubina Directe en sang

* **Iron (Iro)**: Concentració de ferro en sang

* **Oxygen Saturation (%) (OxS)**: Saturació d'oxigen de la sang

* **Ferritin (ng/mL) (Fer)**: Nivells de ferritina en sang

* **Class Attribute (Class)**:[0=Mort; 1=Viu] Supervivent a l'any del diagnóstic d'HCC

## Importància i objectius de l'anàlisi
Amb les dades recopilades al dataset podem intentar saber quines variables estan més relacionades amb la supervivència a l'any. Podem conèixer el grau de correlació entre les variables independents per finalment definir un model de regressió logística per tal d'intentar predir la mortalitat a l'any amb les variables seleccionades.

Poder conèixer la probabilitat de supervivència d'un pacient amb diagnóstic recent d'HCC podrà fer que s'adaptin millors les opcions de tractament, sent més agressius en pacients amb alta probilitat de sobreviure, i en canvi, optant per terapies pal·liatives o de confort per pacients amb pitjor prosnóstic.

## Neteja de les dades
### Preparació del dataset

```{r}
# Importació del dataset
download.file("https://archive.ics.uci.edu/ml/machine-learning-databases/00423/hcc-survival.zip","mydata.zip")
unzip("mydata.zip")
hcc<-read.csv ("hcc-survival/hcc-data.txt",header = F, dec = ".", stringsAsFactors = F, na.strings = "?")

# Noms de les variables
hcc_header<-c("Gender", "Symptoms", "Alcohol", "Hepatitis B Surface Antigen",
              "Hepatitis B e Antigen", "Hepatitis B Core Antibody",
              "Hepatitis C Virus Antibody",  "Cirrhosis", 
              "Endemic Countries","Smoking",  "Diabetes", "Obesity",
              "Hemochromatosis", "Arterial Hypertension", 
              "Chronic Renal Insufficiency", "Human Immunodeficiency Virus",
              "Nonalcoholic Steatohepatitis","Esophageal Varices",
              "Splenomegaly",  "Portal Hypertension", 
              "Portal Vein Thrombosis", "Liver Metastasis", 
              "Radiological Hallmark", "Age at diagnosis", 
              "Grams of Alcohol per day", "Packs of cigarets per year",
              "Performance Status", "Encephalopathy degree", "Ascites degree",
              "International Normalised Ratio", "Alpha-Fetoprotein (ng/mL)",
              "Haemoglobin (g/dL)", "Mean Corpuscular Volume",
              "Leukocytes(G/L)", "Platelets", "Albumin (mg/dL)",
              "Total Bilirubin(mg/dL)",  "Alanine transaminase (U/L)"
              , "Aspartate transaminase (U/L)",
              "Gamma glutamyl transferase (U/L)", 
              "Alkaline phosphatase (U/L)","Total Proteins (g/dL)",
              "Creatinine (mg/dL)","Number of Nodules",
              "Major dimension of nodule (cm)", 
              "Direct Bilirubin (mg/dL)", "Iron", "Oxygen Saturation (%)",
              "Ferritin (ng/mL)", "Class Attribute"   )

hcc_header_cortos<-c("Gen", "Sym", "Alc", "HBS", "HBe", "HBC","HCV",  "Cir",
                     "End","Smo",  "Dia", "Obe", "Hem", "HyA", "CRI", "HIV",
                     "Ste","Eso", "Spl",  "PHT", "PVT", "Met", "Rad", "Age", "gAl",
                     "PCi", "PSt", "Enc", "Asc", "INR", "AFe", "Hae", "MCV",	"Leu",
                     "Pla", "Alb","BiT",  "ALT", "AST","GGT", "ALP","Pro",
                     "Crea","Nod",  "DiN", "BiD", "Iro", "OxS", "Fer", "Class"   )

colnames(hcc)<-hcc_header

tipVar <- c()
for (i in 1:ncol(hcc))  tipVar <- c(tipVar,is(hcc[,i])[1])
tipVar <- table(tipVar)
```

Al nostre dataset, tenim `r tipVar[1]` variables de tipus `r names(tipVar)[1]` i `r tipVar[2]` variables de tipus `r names(tipVar)[2]`.

```{r}
summary(hcc)
``` 

### Descripció del dataset

El dataset està compost de 165 observacions de 49 atributs de pacients amb una variable de classe que registra la supervivència a l'any del diagnóstic. Dels atributs dels pacients, existeixen 26 categorics, 3 dels quals són ordinals ( _Performance Status_, _Encephalopathy degree_, _Ascites degree_), sent la resta numérics. És pot veure que existeixen valors nuls codificats com _NA_.

```{r}
# Definició de tipus de dades per columna
hcc_factor <-c(1:23,50)
hcc_order <- c(27:29)
hcc_factorT<-c(1:23,27:29,50)
hcc_num<-c(24:26,30:49)

# Factorització de les columnes categóriques
hcc <- hcc %>% mutate_at(vars(c(1:23,50)), as.factor)
hcc <- hcc %>% mutate_at(vars(c(27:29)), as.factor)
```

### Valors nuls

La distribució de valors desconeguts per pacient és:
```{r}
table(apply(hcc, 1, function(x) sum(is.na(x))))
```

El percentatge de NAs per variable és: 
```{r}
funNA <- function(a, n){
  a = round(100*a/n,1)
}

totNA <- hcc %>% select(everything()) %>%  #
  summarise_all(funs(sum(is.na(.)))) 
perNA <- totNA %>% mutate_all(funNA, n= nrow(hcc))
tauNA <- totNA %>% bind_rows(perNA)
tauNA <- as_tibble(t(tauNA), rownames = "Variable") %>% 
  rename(`total NA` = V1, `%NA` = V2) %>% 
  arrange(-`total NA`)

tau <- cbind(tauNA[1:25,],tauNA[26:50,])

kable(x = tau, format = "latex", caption = "Variables amb NA", booktabs = TRUE) %>% 
  kable_styling(latex_options = c("HOLD_position", "scale_down"))

```

Només hi ha 8 pacients amb les dades completes, faltant a la majoria de pacients entre 2 i 9 dades. Fins i tot hi ha pacients 13 pacients amb més de 10 dades desconegudes.

Estudiant la distribució dels valors desconeguts per variable veiem que només hi ha 6 variables amb totes les dades íntegres. Amb més de l'10% de dades desconegudes hi ha 16 de les 50 varibles (un 32%), destacant 9 varibles amb entre el 20 i el 50% de les seves dades desconegudes, com són la saturació d'oxigen o els nivells de ferritina en sang. Els valors NA poden seguir una distribució a l'atzar de manera que la proporció dels esperats en cada classe hauria de ser similar. En cas contrari, la correcció dels valors desconeguts podria provocar un biaix cap a un dels dos grups. Vegem com es distribueixen en les variables els valors missing i si hi ha difrències significatives depenent de la clase.

```{r message= FALSE, warning=FALSE}
# Valoració de la distribució dels NA a les variables amb respecte la variable classe 
cero  <- hcc %>% filter(`Class Attribute` == 0)
uno  <- hcc %>% filter(`Class Attribute` == 1)

probTest <- tibble()
for (i in names(hcc[,hcc_factorT])) {
  if (sum(is.na(hcc[,i]))>0){
    casos<-c(sum(is.na(cero[,i])),sum(is.na(uno[,i])))
    long<-c(length(cero[,i]),length(uno[,i]))
    test<-prop.test(x=casos,n=long)
    probTest <- probTest %>%
      bind_rows(c(Clase = i, p_value = test$p.value,
                  prob_0=(casos/long)[1], prob_1=(casos/long)[2],
                  numNA_0=casos[1], numNA_1=casos[2]))
  }
}

testSig <- probTest %>% filter(p_value <= 0.05) %>% 
  mutate_at(.vars = c("p_value", "prob_0","prob_1","numNA_0", "numNA_1"), as.numeric)

kable(x = testSig, format = "latex",
      caption = "Variables amb una difència significativa de NA entre els grups de la classe",
      booktabs = TRUE, digits = 4) %>% 
  kable_styling(latex_options = c("HOLD_position"))

```
A la variable `Symptoms` s'observen molts NA entre els pacients que sobreviuen. Els pacients que no sobreviuen solen presentar molta simptomatologia i aquesta es registra. En canvi, els pacients que no presenten símptomes, poden no registrar-se com a negatiu a aquesta variable, existint un biaix d'informació. 

Igualment succeix a les variables `Hemochromatosis` i `Esophageal Varices`. Els pacients afectats es registren i probablement presenten tases mes altes de mortalitat. En canvi, molts pacients es desconeixerà si presenten hemocromatosis o varius, però probablement no la patiran, i tindran tases de supervivència superiors. 

Corregir aquest valors desconeguts cap a la moda condicionarà un biaix. Per tant, per corregir els valors NA es farà:

* A totes les variables qualitatives s'asignarà el valor més pròxim utilitzant l'algoritme kNN

* A les variables quantitatives s'asignarà la mitjana de la variable. Per tal de no tenir una mitjana condicionada per valors erronis extrems, es corregiran abans de l'asignació del valor mitjà als valors desconguts.

### Correcció valors nuls de variables categòriques

```{r message= FALSE, warning=FALSE}
#computem tots els valors NA de variables factor
factorNames<- colnames(hcc[hcc_factorT,])

# Computar per kNN, abm valors standars, k = 5
hcc <- kNN(hcc, variable = factorNames) %>% subset(select = Gender:`Class Attribute`)
```

### Correcció valors nuls de variables quantitatives

Existeixen dues variables amb valors extranys, incompatibles amb la vida; son `Leukocytes` i `Platelets`
La gran majoria dels valors a la variable `Leukocytes` estan per sota de 100, que és l'esperat. Valors majors son pràcticament impossibles. Els valors d'aquesta variable es solen expressar sobre mm3 pel que solen tenir valors múltiples de 1000, d'aquí la probable confusió amb els valors extrems trobats. Es corregiran modificant les unitats d'aquest valors.

Amb respecte `Platelets`, l'error és similar al trobat a l'anterior variable.

Es corregeix els errors i s'assigna la mitjana als valors desconeguts

```{r message= FALSE, warning=FALSE}
# Correcció valors leucocitosi i plaquetes + assignació mediana als valors NA de variables numeriques
hcc <- hcc %>% 
  mutate(`Leukocytes(G/L)` = ifelse(`Leukocytes(G/L)` > 100,`Leukocytes(G/L)`/100, `Leukocytes(G/L)`),
         Platelets = ifelse(Platelets < 1000,Platelets*1000, Platelets))

for (i in hcc_num){
  hcc[,i] <- ifelse(is.na(hcc[,i]),median(hcc[,i], na.rm = T),hcc[,i])
}

#parlem de mitjana o de mediana? median es mediana, mitjana es mean.

```

## Anàlisi de les dades

Per fer l'anàlisi de les dades numèriques, farem 2 plots per a cada variable. El primer correspon a un análisi dels dels valors numèrics 
i el segon es el boxplot. Sempre separant la variable estudiada en dos clases, les que moren i les que sobreviveixen.

```{r message=FALSE, warning=FALSE}
# Estudi distribució variables Numeriques
ind_CA <- which(colnames(hcc) == "Class Attribute")

ncols <- length(hcc_num) 
if (ncols%%2 == 1){
  last_col = ncols
} else{
  last_col = ncols + 1 
}

#for (i in hcc_num) {
for (i in 1:ncols) {
  if(i%%2 == 1){
    if ( i != last_col){
      data <- hcc[,c(hcc_num[i],hcc_num[i+1],ind_CA )]
    } else{
      data <- hcc[,c(hcc_num[i],ind_CA )]
    }
    name_var <- names(data)
    
    a1<-data %>%
      ggplot(aes(x=data[,1], fill=`Class Attribute`))+
      geom_histogram() +
      labs(fill="Clase", y = "Frequencia", x =name_var[1] ) +
      theme(legend.position = "bottom")
    
    a2<-data %>% 
      ggplot(aes(x=`Class Attribute`,y=data[,1])) +
      geom_boxplot() +
      labs(x = "Clase",  y = name_var[1])
    
    if ( i != last_col){
      a3<-data %>%
        ggplot(aes(x=data[,2], fill=`Class Attribute`))+
        geom_histogram() +
        labs(fill="Clase", y = "Frequencia", x =name_var[2] ) +
        theme(legend.position = "bottom")
      
      a4<-data %>% 
        ggplot(aes(x=`Class Attribute`,y=data[,2])) +
        geom_boxplot() +
        labs(x = "Clase",  y = name_var[2])
      
      grid.arrange(a1,a2,a3,a4,nrow=2)
    } else{
      grid.arrange(a1,a2,nrow=1)
    }
  }
}
```

Crida l'atenció vàries variables amb una distribució molt desplaçada cap a valors baixos però amb valors extrems alts. Molts son valors de laboratori, i sembla que s'adapten més a distribucions logarítmiques, per el que es modificaran. Aquestes variables son:

* Alpha-Fetoprotein (ng/mL)

* Total Bilirubin(mg/dL)

* Alanine transaminase (U/L)

* Aspartate transaminase (U/L)

* Gamma glutamyl transferase (U/L)

* Alkaline phosphatase (U/L)

* Total Proteins (g/dL)

* Creatinine (mg/dL)

* Direct Bilirubin (mg/dL)

```{r message= FALSE, warning=FALSE}
# Transformació logarítmica de variables numériques
ind_CA <- which(colnames(hcc) == "Class Attribute")
hcc_log<-c(31,37:43, 46)

ncols <- length(hcc_log) 
if (ncols%%2 == 1){
  last_col = ncols
} else{
  last_col = ncols + 1 
}

for (i in 1:ncols){
  #transformacio
  hcc[,hcc_log[i]]<- log(hcc[,hcc_log[i]])
  colnames(hcc)[hcc_log[i]] <- paste("log_", colnames(hcc)[hcc_log[i]], sep = '')
  
  if(i%%2 == 1){
    if ( i != last_col){
      data <- hcc[,c(hcc_log[i],hcc_log[i+1],ind_CA )]
    } else{
      data <- hcc[,c(hcc_log[i],ind_CA )]
    }
    
    name_var <- names(data) 
    
    a1<-data %>%
      ggplot(aes(x=data[,1], fill=`Class Attribute`))+
      geom_histogram() +
      labs(fill="Clase", y = "Frequencia", x =name_var[1] ) +
      theme(legend.position = "bottom")
    
    a2<-data %>% 
      ggplot(aes(x=`Class Attribute`,y=data[,1])) +
      geom_boxplot() +
      labs(x = "Clase",  y = name_var[1])
    if( i != last_col){
      a3<-data %>%
        ggplot(aes(x=data[,2], fill=`Class Attribute`))+
        geom_histogram() +
        labs(fill="Clase", y = "Frequencia", x =name_var[2] ) +
        theme(legend.position = "bottom")
      
      a4<-data %>% 
        ggplot(aes(x=`Class Attribute`,y=data[,2])) +
        geom_boxplot() +
        labs(x = "Clase",  y = name_var[2])
      
      grid.arrange(a1,a2,a3,a4,nrow=2)
      
    } else{
      grid.arrange(a1,a2,nrow=1)
      
    }
  }
}
```

```{r message= FALSE, warning=FALSE}
# Distribució variables quantitatives
hcc_factorT<-c(1:23,27:29)

ncols <- length(hcc_factorT) 
if (ncols%%2 == 1){
  last_col = ncols
} else{
  last_col = ncols + 1 
}

#for (i in hcc_num) {
for (i in 1:ncols) {
  if(i%%2 == 1){
    if ( i != last_col){
      data <- hcc[,c(hcc_factorT[i],hcc_factorT[i+1],ind_CA )]
    } else{
      data <- hcc[,c(hcc_factorT[i],ind_CA )]
    }
    name_var <- names(data)
    
    a1<-data %>% 
      ggplot(aes(x=data[,1],fill=`Class Attribute`))+ 
      geom_bar() +
      labs(fill="Clase", x = name_var[1], y = "Frequencia") + 
      theme(legend.position = "bottom")
    
    a2<- data %>% 
      ggplot(aes(x=data[,1],fill=`Class Attribute`))+ 
      geom_bar(position = "fill") +
      labs(fill="Clase", x = name_var[1], y = "Proporcio") +
      theme(legend.position = "bottom")
    if( i != last_col){
      a3<-data %>% 
        ggplot(aes(x=data[,2],fill=`Class Attribute`))+ 
        geom_bar() +
        labs(fill="Clase", x = name_var[2], y = "Frequencia") + 
        theme(legend.position = "bottom")
      
      a4<- data %>% 
        ggplot(aes(x=data[,2],fill=`Class Attribute`))+ 
        geom_bar(position = "fill") +
        labs(fill="Clase", x = name_var[2], y = "Proporcio") +
        theme(legend.position = "bottom")
      
      grid.arrange(a1,a2,a3,a4,nrow=2)
    } else{
      grid.arrange(a1,a2,nrow=1)
    }
  }
}

```


FALTA DESCRIPCIÓN DE LAS VARIABLES!!!!


### Comprobació de la normalitat 
```{r message= FALSE, warning=FALSE}
col.names = colnames(hcc)
tNorm <- tibble()
for (i in 1:ncol(hcc)) {
  if (is.integer(hcc[,i]) | is.numeric(hcc[,i])) {
    p_val = ad.test(hcc[,i])$p.value
    tNorm <- tNorm %>% bind_rows(c("Variable" = col.names[i],"p_value" = p_val))
  }
}
tau <- tNorm %>% filter(p_val < 0.05) %>% 
   mutate_at(.vars = c("p_value"), as.numeric)
tau <- cbind(tau[1:12,],tau[13:24,])

tau[12,3 ] <- ""
tau[12,4 ] <- 0
 



kable(x = tau, format = "latex", caption = "Variables que no segueixen una distribució normal",
      booktabs = TRUE, digits = 4) %>% 
  kable_styling(latex_options = c("HOLD_position", "scale_down"))

```

Com es pot veure, hi ha moltes variables numériques que es distancien significativament de la distribució normal, per el que s'usaran test no paramétrics (Mann–Whitney–Wilcoxon) per la comparativa en relació a la supervivència. 


ATENCIÓN: NO TIENE MUCHO SENTIDO MIRAR HOMOCASTEIDAD DE LAS VARIABLES NO NORMALES!! 



## Proves estadístiques

### Comparació entre grups de la classe

Per tal de valorar quines variables es comporten diferents entre en que sobreviuen i els que no, es realitzarà els diferents test estadístics:

* Per les variables quantititatives, donada les seves distribucións majoritària diferent a la normalitat, es realitzara el test no paramètric de Mann–Whitney–Wilcoxon

* Per les variables qualitatives es realitzarà un test chi-quadrat.

```{r message= FALSE, warning=FALSE}
testSig <- tibble()


cat("Variables categóriques amb p<0.10 entre la classe:\n")
for (i in hcc_factorT) {
tabla=table(hcc[,i], hcc$`Class Attribute`)
chi=chisq.test(tabla)
if (chi$p.value<0.1){
cat(names(hcc)[i],":\n")
cat("p=",chi$p.value, "\n")
testSig <- testSig %>% bind_rows(c(Clase = i, Name=names(hcc[i]),Categorica="1",p_value = chi$p.value))
}
}

cat("\n")
cat("Variables numériques amb p<0.10 entre la classe:\n")
for (i in hcc_num) {
wil=wilcox.test(hcc[hcc$`Class Attribute`==1,i],hcc[hcc$`Class Attribute`==0,i], mu = 0,paired = FALSE, conf.int = 0.95)

if (wil$p.value<0.1){
cat(names(hcc)[i],":\n")
cat("p=",wil$p.value, "\n")
testSig <- testSig %>% bind_rows(c(Clase = i, Name=names(hcc[i]),Categorica="0",p_value = wil$p.value))
}
}
```

Aquestes variables seran les que es seleccionarà per a la creació d'un model de regressió logística, però abans, valorarem les correlacions entre elles per tal de seleccionar variables que estiguin poc relacionades entre elles.


### Correlació entre les variables seleccionades

Amb respecte a la corrrelació entre les variables seleccionades, veiem la seva matriu de correlacions. Donada l'existència de variables categóriques, aquestes es consideradan numériques i usarem la correlació no paramétrica de Spearman per a la seva valoració. Previament es normalitzaran totes les variables quantitatives.


```{r message= FALSE, warning=FALSE}
# Correlación variables independientes.
library(corrplot)
hcc_norm<- hcc
atr<-names(hcc)  
hcc_norm[,hcc_num]<-scale(hcc_norm[,hcc_num])

hcc2<-as.data.frame(lapply(hcc_norm,as.numeric))

names(hcc2)<-atr

hcc_cor<-cor(hcc2[,testSig$Name], method = "spearman")
corrplot(hcc_cor, cl.pos='n',tl.srt = 45, tl.cex = 0.5, type="upper",method = "circle", order="FPC", diag=FALSE)
```


Per intentar reduïr el número de variables del model, d'entre les que han tingut difències significatives entre els que sobreviuen i els que no, seleccionarem les que tingin poca correlació amb altres variables, i amb les que tenen molta correlació amb d'altres, només seleccionarem una com a representiva.


### MELD

Hi ha un valor extès per a valorar la probabilitat de mort als tres mesos de pacients amb hepatopatia que depend de la creatinina, la bilirrubina total i del INR, amb un valor calculat denominat [MELD](https://es.wikipedia.org/wiki/Escala_MELD). Aquest valor és una estimació de probabilitat de fallida hepàtica. A majors valors major probabilitat de mort. Aquest valor està validat pels 3 mesos, no per a l'any, com es el nostre cas. 

```{r message= FALSE, warning=FALSE}

# MELC calculat vs clase
meld<-3.78*hcc$`log_Total Bilirubin(mg/dL)`+ 11.2*log(hcc$`International Normalised Ratio`)+9.57*hcc$`log_Creatinine (mg/dL)`+6.43


hcc$MELD<-meld

plot(hcc$`Class Attribute`, meld)

# Ho no hi ha diferències en la supervivència depenent del MELD
wilcox.test(meld[hcc$`Class Attribute`==1],meld[hcc$`Class Attribute`==0], mu = 0,paired = FALSE, conf.int = 0.95)

```

És pot veure que els valors de MELD són significativament diferents entre el grup de pacients que sobreviuen i els que no.  Amb aquesta combinació lineal agrupem en una única varible la bilirrubina total, l'INR i la creatinina.

Per tant, les variables seleccionades per estudiar amb regressió logística seran:

* Symptoms
* Portal Vein Thrombosis
* Liver Metastasis
* Age at diagnosis
* Performance Status
* log_Alpha-Fetoprotein (ng/mL)
* Haemoglobin (g/dL)
* log_Aspartate transaminase (U/L)
* log_Gamma glutamyl transferase (U/L)
* Major dimension of nodule (cm)
* Iron
* Ferritin (ng/mL)
* MELD


## Model amb regressió logística

Amb les variables seleccionades, es crearà un model de regressió logística per tal de predir la supervivència a l'any del diagnóstic d'HCC. La variable ordinal es considerarà numérica.  

```{r message= FALSE, warning=FALSE}
selecc<-c(2, 21, 22, 24, 27, 31, 32, 39, 40, 45, 47, 49, 51,50)

hcc_sel<-hcc[selecc]

hcc_sel$`Performance Status`<- as.numeric(hcc_sel$`Performance Status`)


modelo <- glm(`Class Attribute` ~ ., data = hcc_sel, family = "binomial")
summary(modelo)

```

Per tal de seleccionar un model amb menys atributs sense disminuir excesivament l'error del model, es realitzarà un estudi iteratiu eliminant a cada pas la variable menys significativa ("backward").

```{r message= FALSE, warning=FALSE}
library(MASS)

modback <- stepAIC(modelo, trace=FALSE, direction="backward")

summary(modback)

```



```{r message= FALSE, warning=FALSE}
library(vcd)
predicciones <- ifelse(test = modback$fitted.values > 0.50, yes = 1, no = 0)
matriz_confusion <- table(hcc_sel$`Class Attribute`, predicciones,
                          dnn = c("observaciones", "predicciones"))
matriz_confusion
mosaic(matriz_confusion, shade = T, colorize = T,
       gp = gpar(fill = matrix(c("green3", "red2", "red2", "green3"), 2, 2)))

cat("\n")
cat("Exactitut del model:\n")
(matriz_confusion[1]+matriz_confusion[4])/nrow(hcc_sel)

```

El model generat te només 6 variables i obté un 82% de precisió en les prediccions. 