---
title: "PRA 2: Neteja, validació i anàlisi de les dades"
author: "Álvaro Díaz i David Leiva"
date: "13/12/2020"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 3

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

******
# Detalls de l'activitat
******
## Presentació
En aquesta pràctica s’elabora un cas pràctic orientat a aprendre a identificar les dades rellevants
per un projecte analític i usar les eines d’integració, neteja, validació i anàlisi de les mateixes

## Competències
En aquesta pràctica es desenvolupen les següents competències del Màster de Data Science:

* Capacitat d'analitzar un problema en el nivell d'abstracció adequat a cada situació i aplicar les habilitats i coneixements adquirits per abordar-lo i resoldre'l.
* Capacitat per aplicar les tècniques específiques de tractament de dades (integració,transformació, neteja i validació) per al seu posterior anàlisi.

## Objectius
Els objectius concrets d’aquesta pràctica són:

* Aprendre a aplicar els coneixements adquirits i la seva capacitat de resolució de problemes en entorns nous o poc coneguts dintre de contextos més amplis o multidisciplinaris.
* Saber identificar les dades rellevants i els tractaments necessaris (integració, neteja i validació) per dur a terme un projecte analític.
* Aprendre a analitzar les dades adequadament per abordar la informació continguda en les dades.
* Identificar la millor representació dels resultats per tal d’aportar conclusions sobre el problema plantejat en el procés analític.
* Actuar amb els principis ètics i legals relacionats amb la manipulació de dades en funció de l'àmbit d'aplicació.
* Desenvolupar les habilitats d'aprenentatge que els permetin continuar estudiant d'una manera que haurà de ser en gran manera autodirigida o autònoma.
* Desenvolupar la capacitat de cerca, gestió i ús d'informació i recursos en l'àmbit de la ciència de dades.


******
# Resolució
******
## Descripció del dataset
Es realitzarà l'anàlisi exploratori (EDA) del dataset https://archive.ics.uci.edu/ml/datasets/HCC+Survival on es recopila informació de pacients amb carcinoma hepatocelullar (HCC) i la seva supervivència a l'any. 

L'HCC és el tumor hepàtic més comú en els pacients amb hepatopatia crónica. La supervivència d'aquests pacients no només depen de l'estadi tumoral si no que també depen de l'estat funcional del fetge. 

El conjunt de dades HCC es va obtenir en l´'Hospital Universitari de Coïmbra (Portugal) i contenia diversos factors demogràfics, de risc, de laboratori i de supervivència global de 165 pacients reals diagnosticats de HCC. El conjunt de dades conté 49 funcions seleccionades segons les directrius de pràctica clínica EASL-EORTC (Associació Europea per a l’Estudi del Fetge - Organització Europea per a la Recerca i el Tractament del Càncer), que són els habituals en la gestió de HCC.

Es tracta d’un conjunt de dades heterogeni, amb 23 variables quantitatives i 26 variables qualitatives. La variable objectiu és la supervivència a 1 any i es va codificar com a variable binària: 0 (mor) i 1 (viu).

Les variables del dataset són:

* **Gender (Gen)**: [1=Home;0=Dona] Sexe del pacient

* **Symptoms (Sym)**:[1=Si;0=No] Sintomàtic

* **Alcohol (Alc)**: [1=Si;0=No] Hepatopatia alcohòlica

* **Hepatitis B Surface Antigen (HBS)**: [1=Si;0=No] Antigen de superfície de l'hepatitis B present a la sang

* **Hepatitis B e Antigen (HBe)**:[1=Si;0=No] Antigen e de l'hepatitis B present a la sang

* **Hepatitis B Core Antibody (HBC)**: [1=Si;0=No] Anticòs per l'hepatitis B present a la sang

* **Hepatitis C Virus Antibody (HCV)**: [1=Si;0=No] Anticòs per l'hepatitis C present a la sang

* **Cirrhosis (Cir)**: [1=Si;0=No] Estadio avançat d'hepatopatia crónica

* **Endemic Countries (End)**: [1=Si;0=No] Pacient procedent de països amb alta prevalença d'hepatitis vírica

* **Smoking (Smo)**: [1=Si;0=No] Fumador

* **Diabetes (Dia)**: [1=Si;0=No] Diabètic

* **Obesity (Obe)**: [1=Si;0=No] Obesitat

* **Hemochromatosis (Hem)**:[1=Si;0=No] Hemocromatosi

* **Arterial Hypertension (HyA)**: [1=Si;0=No] Hipertensió arterial

* **Chronic Renal Insufficiency(CRI)**: [1=Si;0=No] Insuficiència renal

* **Human Immunodeficiency Virus (HIV)**: [1=Si;0=No] Infecció per HIV

* **Nonalcoholic Steatohepatitis (Ste)**: [1=Si;0=No] Esteatosis hepàtica de origen no alcohòlic

* **Esophageal Varices (Eso)**: [1=Si;0=No] Presència de varius esofàgiges com indicador d'hipertensió portal

* **Splenomegaly (Spl)**: [1=Si;0=No] Augment del tamany de la melsa com indicador d'hipertensió portal

* **Portal Hypertension (PHT)**: [1=Si;0=No] Pacient amb hipertensió arterial coneguda

* **Portal Vein Thrombosis (PVT)**: [1=Si;0=No] Presència de trombosi venosa portal

* **Liver Metastasis (Met)**: [1=Si;0=No] Metàstasi hepàtica

* **Radiological Hallmark (Rad)**: [1=Si;0=No]Comportament radiològic típic per HCC

* **Age at diagnosis (Age)**: Anys d'edat al moment del diagnóstic de HCC

* **Grams of Alcohol per day (gAl)**: Grams d'alcohol ingerit de mitjana al dia

* **Packs of cigarets per year (PCi)**: Número de paquets de cigarrets consumits per any

* **Performance Status (PSt)**: [0=Activo;1=Restringit;2=Asistencia ocasional;3=Asistencia parcial;4=Asistencia total;5=Mort] Escala de l'estat general del pacient oncològic

* **Encephalopathy degree (Enc)**: [1=Cap;2=Grau I/II; 3=Grau III/IV] Grau d'afectació mental de l'hepatopatia

* **Ascites degree (Asc)**: [1=Cap;2=Lleu;3=Moderada a Severa] Grau d'ascitis com a indicador indirecte d'hipertensió  portal

* **International Normalised Ratio (INR)**: Temps de protrombina

* **Alpha-Fetoprotein (ng/mL) (AFe)**: Nivells del marcador tumoral a la sang

* **Haemoglobin (g/dL) (Hae)**: Nivells de Hemoglobina a la sang

* **Mean Corpuscular Volume (MCV)**: Volum corpuscular mig dels eritrocits

* **Leukocytes(G/L) (Leu)**: Concentració de cél.lules blanques en sang

* **Platelets (Pla)**: Concentració de plaquestes en sang

* **Albumin (mg/dL) (Alb)**: Nivelss d'albumina en sang

* **Total Bilirubin(mg/dL) (BiT)**: Nivells de Bilirrubina Total en sang

* **Alanine transaminase (U/L) (ALT)**: Nivells d'ALT en sang

* **Aspartate transaminase (U/L) (AST)**: Nivells d'ASP en sang

* **Gamma glutamyl transferase (U/L) (GGT)**: Nivells gamma-GT en sang

* **Alkaline phosphatase (U/L) (ALP)**: Nivelss de fosfatasa alcalina en sang

* **Total Proteins (g/dL) (Pro)**: Concentració total de proteïnes en sang

* **Creatinine (mg/dL) (Crea)**: Concentració de creatinina en sang

* **Number of Nodules (Nod)**: Número de nóduls d'HCC visualitzats

* **Major dimension of nodule (cm) (DiN)**: Tamany major dels nóduls d'HCC

* **Direct Bilirubin (mg/dL) (BiD)**: Nivells de Bilirrubina Directe en sang

* **Iron (Iro)**: Concentració de ferro en sang

* **Oxygen Saturation (%) (OxS)**: Saturació d'oxigen de la sang

* **Ferritin (ng/mL) (Fer)**: Nivells de ferritina en sang

* **Class Attribute (Class)**:[0=Mort; 1=Viu] Supervivent a l'any del diagnóstic d'HCC

## Importància i objectius de l'anàlisi
Amb les dades recopilades al dataset podem intentar saber quines variables estan més relacionades amb la supervivència a l'any. Podem conèixer el grau de correlació entre les variables independents per finalment definir un model de regressió logística per tal d'intentar predir la mortalitat a l'any amb les variables seleccionades.

Poder conèixer la probabilitat de supervivència d'un pacient amb diagnóstic recent d'HCC podrà fer que s'adaptin millors les opcions de tractament, sent més agressius en pacients amb alta probilitat de sobreviure, i en canvi, optant per terapies pal·liatives o de confort per pacients amb pitjor prosnóstic.

## Neteja de les dades
### Preparació del dataset
```{r message= FALSE, warning=FALSE}
library(knitr)

# Importació del dataset
download.file("https://archive.ics.uci.edu/ml/machine-learning-databases/00423/hcc-survival.zip","mydata.zip")
unzip("mydata.zip")
hcc<-read.csv ("hcc-survival/hcc-data.txt",header = F, dec = ".", stringsAsFactors = F, na.strings = "?")

# Noms de les variables
hcc_header<-c("Gender", "Symptoms", "Alcohol", "Hepatitis B Surface Antigen",
              "Hepatitis B e Antigen", "Hepatitis B Core Antibody",
              "Hepatitis C Virus Antibody",  "Cirrhosis", 
              "Endemic Countries","Smoking",  "Diabetes", "Obesity",
              "Hemochromatosis", "Arterial Hypertension", 
              "Chronic Renal Insufficiency", "Human Immunodeficiency Virus",
              "Nonalcoholic Steatohepatitis","Esophageal Varices",
              "Splenomegaly",  "Portal Hypertension", 
              "Portal Vein Thrombosis", "Liver Metastasis", 
              "Radiological Hallmark", "Age at diagnosis", 
              "Grams of Alcohol per day", "Packs of cigarets per year",
              "Performance Status", "Encephalopathy degree", "Ascites degree",
              "International Normalised Ratio", "Alpha-Fetoprotein (ng/mL)",
              "Haemoglobin (g/dL)", "Mean Corpuscular Volume",
              "Leukocytes(G/L)", "Platelets", "Albumin (mg/dL)",
              "Total Bilirubin(mg/dL)",  "Alanine transaminase (U/L)"
              , "Aspartate transaminase (U/L)",
              "Gamma glutamyl transferase (U/L)", 
              "Alkaline phosphatase (U/L)","Total Proteins (g/dL)",
              "Creatinine (mg/dL)","Number of Nodules",
              "Major dimension of nodule (cm)", 
              "Direct Bilirubin (mg/dL)", "Iron", "Oxygen Saturation (%)",
              "Ferritin (ng/mL)", "Class Attribute"   )

hcc_header_cortos<-c("Gen", "Sym", "Alc", "HBS", "HBe", "HBC","HCV",  "Cir",
               "End","Smo",  "Dia", "Obe", "Hem", "HyA", "CRI", "HIV",
               "Ste","Eso", "Spl",  "PHT", "PVT", "Met", "Rad", "Age", "gAl",
               "PCi", "PSt", "Enc", "Asc", "INR", "AFe", "Hae", "MCV",	"Leu",
               "Pla", "Alb","BiT",  "ALT", "AST","GGT", "ALP","Pro",
               "Crea","Nod",  "DiN", "BiD", "Iro", "OxS", "Fer", "Class"   )

colnames(hcc)<-hcc_header
str(hcc)
```

### Descripció del dataset

El dataset està compost de 165 observacions de 49 atributs de pacients amb una variable de classe que registra la supervivència a l'any del diagnóstic. Dels atributs dels pacients, existeixen 26 categorics, 3 dels quals són ordinals ( _Performance Status_, _Encephalopathy degree_, _Ascites degree_), sent la resta numérics. És pot veure que existeixen valors nuls codificats com _NA_.

```{r message= FALSE, warning=FALSE}
# Definició de tipus de dades per columna
hcc_factor <-c(1:23,50)
hcc_order <- c(27:29)
hcc_factorT<-c(1:23,27:29,50)
hcc_num<-c(24:26,30:49)

# Factorització de les columnes categóriques
hcc[hcc_factor]<-lapply(hcc[hcc_factor], as.factor)
hcc[hcc_order]<-lapply(hcc[hcc_order], factor,ordered=T)

```


### Valors nuls

```{r message= FALSE, warning=FALSE}
## NA

### Distribució de valors desconeguts per pacient
print("Distribució de valors desconeguts per pacient")
table(apply(hcc, 1, function(x) sum(is.na(x))))

# Valores NA por variable
print("Distribució de valors desconeguts per variable")
table(colSums(is.na(hcc)))
sort (colSums(is.na(hcc)), decreasing = TRUE)

```

Només hi ha 8 pacients amb les dades completes, faltant a la majoria de pacients entre 2 i 9 dades. Fins i tot hi ha pacients 13 pacients amb més de 10 dades desconegudes, el que podria fer-nos desconfiar de les dades d'aquests pacients, de manera que s'elimaran les dades d'aquests 13 pacients amb més de 10 o més valors desconeguts.

Estudiant la distribució dels valors desconeguts per variable veiem que només hi ha 13 columnes amb totes les dades íntegres. Amb més de l'10% de dades desconegudes hi ha 15 de les 50 varibles (un 30%), destacant 9 columnes amb entre el 20 i el 50% de les seves dades desconegudes, com són la saturació d'oxigen o els nivells de ferritina en sang. Els valors NA poden seguir una distribució a l'atzar de manera que la proporció dels esperats en cada classe hauria de ser similar. En cas contrari, la correcció dels valors desconeguts podria provocar un biaix cap a un dels dos grups. Vegem com es distribueixen en les variables amb més d'un 10% de valors missing i si alguna presenta una diferència més gran de l'20% del que s'esperava.

```{r message= FALSE, warning=FALSE}
# Valoració de la distribució dels NA a les variables amb >10% de NA amb
# respecte la variable classe 
hcc_colNA<-names(hcc[hcc_factor][colSums(is.na(hcc[hcc_factor]))>15])
hcc_colNA20<-c()


for (i in hcc_colNA)
  {
    print (i)
    aa<-prop.test(table(hcc[,i],hcc$`Class Attribute`))
    
    if (aa[["p.value"]]<0.05){
      hcc_colNA20<-append(hcc_colNA20,i)
    }
    print(table(hcc[,i],hcc$`Class Attribute`))
    print (aa[["p.value"]])
  }

cat("\nVariables amb una difència significativa de NA entre els grups de la classe\n",hcc_colNA20)

```
